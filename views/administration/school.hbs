{{#extend "administration/administration"}}
{{#content "styles" mode="append"}}
<link rel="stylesheet" href="/styles/administration/school.css" />
<link rel="stylesheet" href="/styles/administration/progress-static.css" />
{{/content}}

{{#content "scripts" mode="append"}}
<script src="/scripts/administration/school.js" type="text/javascript" nonce="{{nonceValue}}" defer></script>
{{/content}}

{{#content "page" mode="prepend"}}
<div class="route-administration">
	<section class="section-school section-default">
		<h2 class="h4">
			{{#if schoolMaintanance.schoolUsesLdap}}
			{{$t "administration.school.label.schoolYearChange" }}
			{{else}}
			{{$t "administration.school.label.schoolYear" }} {{../school.currentYear.name}}
			{{/if}}
		</h2>
		<p>
			{{#if schoolMaintanance.schoolUsesLdap}}
			{{#ifeq schoolMaintananceMode "active"}}
			{{$t "administration.school.label.transferPhase" }}
			{{else}}
			{{$t "administration.school.label.currentSchoolYear" }} {{../school.currentYear.name}}
			{{/ifeq}}
			{{else}}
			{{$t "administration.school.text.theNewSchoolYearStartsInThe" }} {{theme.title}} {{$t "administration.school.text.withThePreparationTimeOneWeekBefore" }}
			{{/if}}
		</p>
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-12 no-padding">
					{{#if schoolMaintanance.schoolUsesLdap}}
					<p>{{$t "administration.school.text.useTheTransferPhaseAroundTheSchoolYear" }}</p>
					<p><a class="ldapschoolyearadditionalinfotoggle" href="#">{{$t "administration.school.link.moreInfo" }} ></a></p>
					<div id="ldapschoolyearadditionalinfo">
						<p>{{$t "administration.school.text.backgroundSoThatEveryStudentAndTeacher" }}
						</p>
						<p class="font-weight-bold">{{$t "administration.school.label.duringTheSchoolYear" }}</p>
						<ul>
							<li>{{$t "administration.school.text.newUsersClassAffiliationsAnd" }}</li>
						</ul>
						<p class="font-weight-bold">{{$t "administration.school.label.startOfTheTransferPhase" }}</p>
						<ul>
							<li>{{$t "administration.school.text.youCanStartTheTransferPhase" }}</li>
							<li>{{$t "administration.school.text.ifThereIsNoManualStart" }}
							</li>
						</ul>
						<p class="font-weight-bold">{{$t "administration.school.label.duringTheTransferPhase" }}</p>
						<ul>
							<li>{{$t "administration.school.text.newUsersClassesAndChanges" }}</li>
							<li class="font-weight-bold">du kannst die notwendigen Änderungen für das neue Schuljahr im
								LDAP vornehmen (neue Nutzer, Update der Klassen)</li>
							<li>{{$t "administration.school.text.loginViaLDAP" }}</li>
							<li>{{$t "administration.school.text.passwordChanges" }}</li>
							<li>{{$t "administration.school.text.coursesWithLearningContent" }}</li>
						</ul>
						<p class="font-weight-bold">{{$t "administration.school.label.endOfTheTransferPhase" }}</p>
						<ul>
							<li>{{$t "administration.school.text.doNotEndTheTransferPhase" }}</li>
							<li>{{$t "administration.school.text.atTheEndOfTheTransferPhase" }}</li>
							<li>gleichzeitig läutest Du damit das neue Schuljahr in der Schul-Cloud ein</li>
							<li>{{$t "administration.school.text.theNewClassesAreSavedInTheContext" }}</li>
						</ul>
						<p class="font-weight-bold">{{$t "administration.school.label.afterTheTransferPhaseEnded" }}</p>
						<ul>
							<li>{{$t "administration.school.text.theNewClassesCanNowBeAssignedt" }}</li>
							<li>{{$t "administration.school.text.allDataFromTheLDAP" }}</li>
						</ul>
					</div>
					{{#ifeq schoolMaintananceMode "idle"}}
					<button type="submit" class="btn btn-primary disabled">
						{{$t "administration.school.button.endSchoolYear" }}
					</button>
					<p>{{$t "administration.school.text.thisOptionIsAvailable" }}</p>
					{{else}}
					<p class="font-weight-bold">{{$t "administration.school.text.atTheEndOfTheSchoolYearWithLDAP" }}</p>
					<section class="section-course">
						<div class="wizard-card">
							<div class="row">
								<div class="col-xs-4 text-center">
									{{$t "administration.school.text.oldSchoolYear" }}
								</div>
								<div class="col-xs-4 text-center">
									{{$t "administration.school.text.allAboutTheSummerVacation" }}
								</div>
								<div class="col-xs-4 text-center">
									{{$t "administration.school.text.newSchoolYear" }}
								</div>
							</div>


							<div class="row stages">
								<div class="col-xs-4 text-center">
									<label id="section-1"
										class="{{#ifeq ../schoolMaintananceMode "standby"}}current{{else}}done{{/ifeq}}">
										{{#ifeq ../schoolMaintananceMode "standby"}}1{{else}}&#x2713;{{/ifeq}}
									</label>
								</div>
								<div class="col-xs-4 text-center">
									<label id="section-2"
										class="{{#ifeq ../schoolMaintananceMode "active"}}current{{/ifeq}}">2</label>
								</div>
								<div class="col-xs-4 text-center">
									<label id="section-3">3</label>
								</div>
							</div>

							<span class="progressbar"></span>
							<div class="row head">
								<div class="col-xs-4">
									<p>{{$t "administration.school.label.noteBeforeTheTransferPhase" }}</p>
								</div>
								<div class="col-xs-4">
									<p>{{$t "administration.school.label.noteAvailableFunction" }} <br> {{$t "administration.school.label.inTheTransferPhase" }}</p>
								</div>
								<div class="col-xs-4">
									<p>{{$t "administration.school.label.afterTheTransferPhaseEnded" }}<br> {{$t "administration.school.label.yourSchoolCanStartNewSchool" }}
										{{$t "administration.school.button.start" }}</p>
								</div>
							</div>
							<div class="row body">
								<div class="col-xs-4">
									<p><i class="fa fa-arrow-right"></i>{{$t "administration.school.label.youCantGoBack" }}</p>
								</div>
								<div class="col-xs-4">
									<div class="d-flex justify-content-center">
										<p><i class="fa fa-check green"></i> {{$t "administration.school.label.loginFromExistingUsers" }}</p>
										<p><i class="fa fa-check green"></i> {{$t "administration.school.label.passwordChangesInLDAP" }}</p>
										<p><i class="fa fa-times red"></i> {{$t "administration.school.label.changeOfClasses" }}</p>
										<p><i class="fa fa-times red"></i> {{$t "administration.school.label.changeOfUserData" }}</p>
									</div>
								</div>
								<div class="col-xs-4">
									<p><i class="fa fa-smile-o"></i> {{$t "administration.school.text.allDone" }}</p>
								</div>
							</div>
							<form action="/administration/startschoolyear" type="post">
								{{> "lib/components/csrfInput"}}
								<div class="row">
									<div class="col-xs-12 col-md-4 text-center">
										<button {{#ifeq ../schoolMaintananceMode "standby"}}{{else}}disabled{{/ifeq}}
											class="btn btn-primary btn-terminate-school-year">{{$t "administration.school.label.transferPhase" }}
											{{$t "administration.school.button.start" }}</button>
									</div>
									<div class="col-xs-12 col-md-4 text-center">
										<p><a href="#" id="checkldapdata"
												class="btn btn-primary {{#ifeq ../schoolMaintananceMode "active"}}{{else}}disabled{{/ifeq}}">{{$t "administration.school.button.checkLDAPData" }}</a></p>
										<label>
											<input required disabled type="checkbox" id="startldapschoolyear">
											{{$t "administration.school.label.userAndClassDataInLDAP" }} <br> {{$t "administration.school.label.processedForTheNewSchoolYear" }}
										</label>
									</div>
									<div class="col-xs-12 col-md-4 text-center">
										<button disabled id="buttonstartldapschoolyear"
											class="btn btn-primary">{{$t "administration.school.button.endTransferPhase" }}</button>
									</div>
								</div>
							</form>
						</div>
					</section>
					{{/ifeq}}
					{{/if}}
				</div>
			</div>
		</div>

		{{#embed "lib/components/modal-form" action="/administration/terminateschoolyear" method="post" class="terminate-school-year-modal"}}
		{{#content "fields"}}
		{{> "administration/forms/form-terminate-school-year"}}
		{{/content}}
		{{/embed}}
	</section>

	<section class="section-school section-default">
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-12 no-padding">
					<!-- Admin View -->
					{{#userHasPermission 'ADMIN_VIEW'}}
					<h2 class="h4">Schule</h2>

					<form action="/administration/schools/{{../currentSchool}}" method="post" class="edit-form-school">
						<input type="hidden" name="_method" value="patch" />
						<div class="form-group">
							<label>{{$t "administration.school.label.nameOfTheSchool" }}</label>
							<input value="{{../school.name}}" type="text" class="form-control" name="name"
								placeholder="Einhorn Gymnasium" {{#if ../schoolUsesLdap}} readonly{{/if}}
								{{#if ../isExpertSchool}} readonly{{/if}} {{#userHasPermission 'SCHOOL_EDIT'}}{{else}}
								readonly{{/userHasPermission}} required />
						</div>

						<div class="form-group">
							<label>{{$t "administration.school.label.uploadSchoolLogo" }}</label><br />
							<input type="hidden" name="logo_dataUrl">
							<input type="file" id="logo-input">
							<label for="logo-input" class="btn btn-secondary">{{$t "administration.school.button.chooseAFile" }}</label>
							<span id="logo-filename">{{$t "administration.school.text.noFileSelected" }}</span>
							<img id="preview-logo" src="">
							<canvas id="logo-canvas" width="35" height="35" class="hidden"></canvas>
						</div>

						{{#ifConfig "FEATURE_ADMIN_TOGGLE_STUDENT_VISIBILITY" "enabled"}}
							<h2 class="h6 mt-2">Datenschutz-Einstellungen</h2>
							<div class="form-group">
								<label>
									<input type="checkbox" name="studentVisibility" value="true"
										{{#if ../studentVisibility}}checked{{/if}}>
									Sichtbarkeit von Schüler:innen für Lehrkräfte aktivieren <i class="fa fa-eye"></i>
									<p class="text-muted">
										Die Aktivierung dieser Option hat datenschutzrechtlich eine hohe Schwelle. Um die Sichtbarkeit aller Schülerinnen und Schüler der Schule für jeden Lehrer zu aktivieren, ist es erforderlich, dass jede Schülerin und jeder Schüler wirksam in diese Datenverarbeitung eingewilligt hat.
									</p>
								</label>
							</div>
						{{/ifConfig}}

						{{#ifConfig "FEATURE_MESSENGER_SCHOOL_SETTINGS_VISIBLE" true}}
							<div class="form-group">
								<label>
									<input
										id="messenger"
										type="checkbox"
										name="messenger"
										value="true"
										{{#inArray "messenger" ../school.features}}checked{{/inArray}}
										{{#userHasPermission 'SCHOOL_EDIT'}}{{else}}
											{{#userHasPermission 'SCHOOL_CHAT_MANAGE'}}{{else}}
												disabled
											{{/userHasPermission}}
										{{/userHasPermission}}
                                    />
									{{$t "administration.school.label.activeChatFunction" }}
									<p class="text-muted">
										{{$t "administration.school.text.ifChatsAreActivatedAtYourSchool" }}
									</p>
								</label>
							</div>

							{{#ifConfig "FEATURE_MESSENGER_SCHOOL_ROOM_ENABLED" true}}
								<div id="messenger-sub-options">
									<div class="form-group">
										<label>
											<input
												type="checkbox"
												name="messengerSchoolRoom"
												value="true"
												{{#inArray "messengerSchoolRoom" ../school.features}}checked{{/inArray}}
												{{#userHasPermission 'SCHOOL_EDIT'}}{{else}}
													{{#userHasPermission 'SCHOOL_CHAT_MANAGE'}}{{else}}
														disabled
													{{/userHasPermission}}
												{{/userHasPermission}}
											/>
											Chatraum für Ankündigungen an die gesamte Schule anlegen
											<p class="text-muted">
												Der Ankündigungs-Chatraum ermöglicht Schul-Administrator:innen, Nachrichten an die gesamte Schule zu senden.
												Schüler:innen haben in diesem Raum nur Lesezugriff, sehen sich aber gegenseitig und können so private Chats starten.
											</p>
										</label>
									</div>
								</div>
							{{/ifConfig}}
						{{/ifConfig}}

						{{#ifConfig "FEATURE_MESSENGER_SCHOOL_SETTINGS_VISIBLE" false}}
							{{#if @root.ROCKETCHAT_SERVICE_ENABLED}}
								<div class="form-group">
									<label>
										<input type="checkbox" name="rocketchat" value="true"
											{{#inArray "rocketChat" ../school.features}}checked{{/inArray}}>
										{{$t "administration.school.label.activeChatFunction" }}
										<p class="text-muted">
											{{$t "administration.school.text.ifChatsAreActivatedAtYourSchoolTeamAdministratorsCan" }}
										</p>
									</label>
								</div>
							{{/if}}
						{{/ifConfig}}

						{{#ifConfig "FEATURE_VIDEOCONFERENCE_ENABLED" true}}
						<div class="form-group">
							<label>
								<input type="checkbox" name="videoconference" value="true"
									{{#inArray "videoconference" ../../school.features}}checked{{/inArray}}>
								{{$t "administration.school.label.enableVideoConference" }}
								<p class="text-muted">
									{{$t "administration.school.text.ifVideoConferenceAreActivatedAtYourSchool" }}
								</p>
							</label>
						</div>
						{{/ifConfig}}
						{{#if ../school.fileStorageType}}
						<div class="form-group">
							<label>{{$t "administration.school.label.cloudStorageProvider" }}</label>
							<select name="fileStorageType" type="text" {{#userHasPermission 'SCHOOL_EDIT'}}{{else}}
								disabled{{/userHasPermission}}>
								{{#each ../provider}}
								<option value="{{this.value}}" {{#if this.selected}} selected{{/if}}>{{this.label}}
								</option>
								{{/each}} </select> </div> {{/if}}
						{{> "lib/components/csrfInput"}}
						<button type="submit" class="btn btn-primary btn-submit">{{$t "administration.school.button.save" }}</button>
					</form>

					{{#if ../school.fileStorageType}}
					<div style="padding-top: 20px">
						<label>{{$t "administration.school.label.fileStorageSpaceUsedInCloud" }}</label>
						<p>{{$t "administration.school.text.yourSchoolIsCurrentlyDrawing" }} {{writeFileSizePretty ../totalStorage.totalSize}}.</p>
					</div>
					{{/if}}
					{{/userHasPermission}}
				</div>
			</div>
		</div>
	</section>
	{{#unless school.fileStorageType}}
	<section class="section-school section-default">
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-12 no-padding">
					<form action="/administration/schools/{{currentSchool}}/bucket" method="post"
						class="edit-form-school">

						<div class="form-group">
							<label>{{$t "administration.school.label.cloudStorageProvider" }}</label>
							<select name="fileStorageType" type="text">
								<option disabled="disabled" selected="selected">{{$t "administration.school.label.selectProvider" }}</option>
								{{#each provider}}
								<option value="{{this.value}}" {{#if this.selected}} selected{{/if}}>{{this.label}}
								</option>
								{{/each}}
							</select> </div>

						{{> "lib/components/csrfInput"}}
						<button type="submit" class="btn btn-primary btn-submit">{{$t "administration.school.button.save" }}</button>

					</form>
				</div>
			</div>
		</div>
	</section>
	{{/unless}}
	{{#userHasPermission 'SCHOOL_EDIT'}}
		{{#ifConfig "FEATURE_SCHOOL_POLICY_ENABLED" true}}
		<section class="section-school section-default">
			<h2 class="h4">Datenschutzerklärung</h2>
			<div class="container-fluid">
				<div class="row">
					<div class="col-sm-12 no-padding">
						{{> "lib/components/table" head=../policiesHead body=../policiesBody}}
					</div>
				</div>
				<div class="row">
					<div class="col-sm-12 no-padding">
						<button type="submit" class="btn btn-primary btn-add-modal--policy">
							Datenschutzerklärung hinzufügen
						</button>
					</div>
				</div>
			</div>
		</section>
		{{/ifConfig}}

	<section class="section-school section-default">
		<h2 class="h4">{{$t "administration.school.label.authentication" }}</h2>
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-12 no-padding">
					{{> "lib/components/table" head=../systemsHead body=../systemsBody}}
				</div>
			</div>
			<div class="row">
				<div class="col-sm-12 no-padding">
					<form action="/administration/systems/ldap/add" method="POST">
						{{> "lib/components/csrfInput"}}
						<button type="submit" class="btn btn-primary btn-add-modal ">
							{{$t "administration.school.button.addSystem" }}
						</button>
						{{#if ../ldapAddable}}
						<button type="submit" class="btn btn-primary">
							{{$t "administration.school.button.addLDAPSystem" }}
						</button>
						{{/if}}
					</form>
				</div>
			</div>
		</div>
	</section>
	{{/userHasPermission}}

	{{#embed "lib/components/modal-form" method="patch" class="edit-modal" collapseId=1}}
	{{#content "fields"}}
	{{> "administration/forms/form-systems"}}
	{{/content}}
	{{/embed}}

	{{#embed "lib/components/modal-form" action="/administration/systems/" method="post" class="add-modal"
    collapseId=2}}
	{{#content "fields"}}
	{{> "administration/forms/form-systems"}}
	{{/content}}
	{{/embed}}

	{{#embed "lib/components/modal-form" body=systemsBody method="delete" class="delete-modal"}}
	{{#content "fields"}}
	{{> "administration/forms/form-delete-alias"}}
	{{/content}}
	{{/embed}}

	{{#embed "lib/components/modal-form" action="/administration/schools/policy" method="post" class="add-modal--policy"
			 collapseId=3}}
		{{#content "fields"}}
			{{> "administration/forms/form-policy"}}
		{{/content}}
	{{/embed}}


	<section class="section-school section-default">
		<h2 class="h4">RSS-Feeds</h2>
		<div class="container-fluid">
			<div class="row">
				{{#if hasRSS}}
				<div class="col-sm-12 no-padding">
					{{> "lib/components/table" head=rssHead body=rssBody}}
				</div>
				{{else}}
				<p>{{$t "administration.school.text.noRssFeedsYet" }}</p>
				{{/if}}
			</div>
			<div class="row">
				<div class="col-sm-12 no-padding">
					<button type="submit" class="btn btn-primary btn-add-modal--rss">
						{{$t "administration.school.button.addRSSFeed" }}
					</button>
				</div>
			</div>
		</div>

		{{#embed "lib/components/modal-form" action="/administration/rss/" method="post" class="add-modal--rss"
        collapseId=3}}
		{{#content "fields"}}
		{{> "administration/forms/form-rss"}}
		{{/content}}
		{{/embed}}

		{{#embed "lib/components/modal-form" body=rssBody method="delete" class="delete-modal--rss"}}
		{{#content "fields"}}
		{{> "administration/forms/form-delete-rss"}}
		{{/content}}
		{{/embed}}

	</section>
</div>
{{/content}}
{{/extend}}
